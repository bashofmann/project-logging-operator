# Project Logging Operator

This chart is deploys a Helm Project Operator (based on the [rancher/helm-project-operator](https://github.com/rancher/helm-project-operator)), an operator that manages deploying Helm charts each containing a Project Logging ClusterFlow that is automatically configured to pick up the logs of all namespaces of a project and add a `projectID` field to each log message.

> **Important Note: Project Logging Operator is designed to be deployed alongside an existing Rancher Logging deployment in a cluster that has already installed the Rancher Logging CRDs.**
 
## Pre-Installation: Using Project Logging Operator with Rancher and rancher-logging

If you are running your cluster on [Rancher](https://rancher.com/) and already have [rancher-logging](https://rancher.com/docs/rancher/v2.6/en/logging/) deployed onto your cluster, Project Logging Operator's default configuration should already be configured to work with your existing Logging Stack; however, here are some notes on how we recommend you configure rancher-logging to optimize the security and usability of Project Logging Operator in your cluster:

### Ensure the cattle-logging-system namespace is placed into the System Project (or a similarly locked down Project that has access to other Projects in the cluster)

Project Logging Operator's security model expects that the namespace it is deployed into (`cattle-logging-system`) has limited access for anyone except Cluster Admins to avoid privilege escalation via execing into Pods (such as the Jobs executing Helm operations).

## How does the operator work?

1. On deploying this chart, users can create ProjectHelmCharts CRs with `spec.helmApiVersion` set to `logging.cattle.io/v1alpha1` in a **Project Registration Namespace (`cattle-project-<id>`)**. 
2. On seeing each ProjectHelmChartCR, the operator will automatically deploy a Project Logging ClusterFlow the Project Owner's behalf in the **Logging Namespace (`cattle-logging-system`)** based on a HelmChart CR and a HelmRelease CR automatically created by the ProjectHelmChart controller in the **Operator / System Namespace**.

### What is a Project?

In Project Logging Operater, a Project is a group of namespaces that can be identified by a `metav1.LabelSelector`; by default, the label used to identify projects is `field.cattle.io/projectId`, the label used to identify namespaces that are contained within a given [Rancher](https://rancher.com/) Project.

### Configuring the Helm release created by a ProjectHelmChart

The `spec.values` of this ProjectHelmChart resources will correspond to the `values.yaml` override to be supplied to the underlying Helm chart deployed by the operator on the user's behalf; to see the underlying chart's `values.yaml` spec, either:
- View to the chart's definition located at [`bashofmann/project-logging-operator` under `charts/rancher-project-logging`](https://github.com/bashofmann/project-logging-operator/blob/main/charts/rancher-project-logging) (where the chart version will be tied to the version of this operator)
- Look for the ConfigMap named `logging.cattle.io.v1alpha1` that is automatically created in each Project Registration Namespace, which will contain both the `values.yaml` and `questions.yaml` that was used to configure the chart (which was embedded directly into the `project-logging-operator` binary).

### Namespaces

As a Project Operator based on [rancher/helm-project-operator](https://github.com/rancher/helm-project-operator), Project Logging Operator has three different classifications of namespaces that the operator looks out for:
1. **Operator / System Namespace**: this is the namespace that the operator is deployed into (e.g. `cattle-logging-system`). This namespace will contain all HelmCharts and HelmReleases for all ProjectHelmCharts watched by this operator. **Only Cluster Admins should have access to this namespace.**
2. **Project Registration Namespace (`cattle-project-<id>`)**: this is the set of namespaces that the operator watches for ProjectHelmCharts within. The RoleBindings and ClusterRoleBindings that apply to this namespace will also be the source of truth for the auto-assigned RBAC created in the Project Release Namespace (see more details below). **Project Owners (admin), Project Members (edit), and Read-Only Members (view) should have access to this namespace**.
> Note: Project Registration Namespaces will be auto-generated by the operator and imported into the Project it is tied to if `.Values.global.cattle.projectLabel` is provided (which is set to `field.cattle.io/projectId` by default); this indicates that a Project Registration Namespace should be created by the operator if at least one namespace is observed with that label. The operator will not let these namespaces be deleted unless either all namespaces with that label are gone (e.g. this is the last namespace in that project, in which case the namespace will be marked with the label `"helm.cattle.io/helm-project-operator-orphaned": "true"`, which signals that it can be deleted) or it is no longer watching that project (because the project ID was provided under `.Values.helmProjectOperator.otherSystemProjectLabelValues`, which serves as a denylist for Projects). These namespaces will also never be auto-deleted to avoid destroying user data; it is recommended that users clean up these namespaces manually if desired on creating or deleting a project
> Note: if `.Values.global.cattle.projectLabel` is not provided, the Operator / System Namespace will also be the Project Registration Namespace
3. **Namespace for project logging resources (`cattle-logging-system`)**: this is the namespaces that the operator deploys a ClusterFlow within on behalf of a ProjectHelmChart. **Only Cluster Admins should have access to this namespace**

### Helm Resources (HelmChart, HelmRelease)

On deploying a ProjectHelmChart, the Project Logging Operator will automatically create and manage two child custom resources that manage the underlying Helm resources in turn:
- A HelmChart CR (managed via an embedded [k3s-io/helm-contoller](https://github.com/k3s-io/helm-controller) in the operator): this custom resource automatically creates a Job in the same namespace that triggers a `helm install`, `helm upgrade`, or `helm uninstall` depending on the change applied to the HelmChart CR; this CR is automatically updated on changes to the ProjectHelmChart (e.g. modifying the values.yaml) or changes to the underlying Project definition (e.g. adding or removing namespaces from a project). 
> **Important Note: If a ProjectHelmChart is not deploying or updating the underlying Project Logging for some reason, the Job created by this resource in the Operator / System namespace should be the first place you check to see if there's something wrong with the Helm operation; however, this is generally only accessible by a Cluster Admin.**
- A HelmRelease CR (managed via an embedded [rancher/helm-locker](https://github.com/rancher/helm-locker) in the operator): this custom resource automatically locks a deployed Helm release in place and automatically overwrites updates to underlying resources unless the change happens via a Helm operation (`helm install`, `helm upgrade`, or `helm uninstall` performed by the HelmChart CR).
> Note: HelmRelease CRs emit Kubernetes Events that detect when an underlying Helm release is being modified and locks it back to place; to view these events, you can use `kubectl describe helmrelease <helm-release-name> -n <operator/system-namespace>`; you can also view the logs on this operator to see when changes are detected and which resources were attempted to be modified

Both of these resources are created for all Helm charts in the Operator / System namespaces to avoid escalation of privileges to underprivileged users.

### RBAC

As described in the section on namespaces above, Project Logging Operator expects that Project Owners, Project Members, and other users in the cluster with Project-level permissions (e.g. permissions in a certain set of namespaces identified by a single label selector) have minimal permissions in any namespaces except the Project Registration Namespace (which is imported into the project by default) and those that already comprise their projects. Therefore, in order to allow Project Owners to assign specific chart permissions to other users in their Project namespaces, the Helm Project Operator will automatically watch the following bindings:
- ClusterRoleBindings
- RoleBindings in the Project Release Namespace

On observing a change to one of those types of bindings, the Helm Project Operator will check whether the `roleRef` that the binding points to matches a ClusterRole with the name provided under `helmProjectOperator.releaseRoleBindings.clusterRoleRefs.admin`, `helmProjectOperator.releaseRoleBindings.clusterRoleRefs.edit`, or `helmProjectOperator.releaseRoleBindings.clusterRoleRefs.view`; by default, these roleRefs correspond will correspond to `admin`, `edit`, and `view` respectively, which are the [default Kubernetes user-facing roles](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#user-facing-roles).

> Note: for Rancher RBAC users, these [default Kubernetes user-facing roles](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#user-facing-roles) directly correlate to the `Project Owner`, `Project Member`, and `Read-Only` default Project Role Templates.

If the `roleRef` matches, the Helm Project Operator will filter the `subjects` of the binding for all Users and Groups and use that to automatically construct a RoleBinding for each Role in the Project Release Namespace with the same name as the role and the following labels:
- `helm.cattle.io/project-helm-chart-role: {{ .Release.Name }}`
- `helm.cattle.io/project-helm-chart-role-aggregate-from: <admin|edit|view>`

### Advanced Helm Project Operator Configuration

| Value                                                            | Configuration                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `helmProjectOperator.valuesOverride`                             | Allows an Operator to override values that are set on each ProjectHelmChart deployment on an operator-level; user-provided options (specified on the `spec.values` of the ProjectHelmChart) are automatically overridden if operator-level values are provided. For an exmaple, see how the default value overrides `federate.targets` (note: when overriding list values like `federate.targets`, user-provided list values will **not** be concatenated) |
| `helmProjectOperator.projectReleaseNamespaces.labelValues`       | The value of the Project that all Project Release Namespaces should be auto-imported into (via label and annotation). Not recommended to be overridden on a Rancher setup.                                                                                                                                                                                                                                                                                 |
| `helmProjectOperator.otherSystemProjectLabelValues`              | Other namespaces that the operator should treat as a system namespace that should not be monitored. By default, all namespaces that match `global.cattle.systemProjectId` will not be matched. `cattle-logging-system` and `kube-system` are explicitly marked as system namespaces as well, regardless of label or annotation.                                                                                                                            |
| `helmProjectOperator.releaseRoleBindings.aggregate`              | Whether to automatically create RBAC resources in Project Release namespaces                                                                                                                                                                                                                                                                                                                                                                               |
| `helmProjectOperator.releaseRoleBindings.clusterRoleRefs.<admin\ | edit\                                                                                                                                                                                                                                                                                                                                                                                                                                                      |view>`| ClusterRoles to reference to discover subjects to create RoleBindings for in the Project Release Namespace for all corresponding Project Release Roles. See RBAC above for more information |
| `helmProjectOperator.hardenedNamespaces.enabled`                 | Whether to automatically patch the default ServiceAccount with `automountServiceAccountToken: false` and create a default NetworkPolicy in all managed namespaces in the cluster; the default values ensure that the creation of the namespace does not break a CIS 1.16 hardened scan                                                                                                                                                                     |
| `helmProjectOperator.hardenedNamespaces.configuration`           | The configuration to be supplied to the default ServiceAccount or auto-generated NetworkPolicy on managing a namespace                                                                                                                                                                                                                                                                                                                                     |
| `helmProjectOperator.helmController.enabled`                     | Whether to enable an embedded k3s-io/helm-controller instance within the Helm Project Operator. Should be disabled for RKE2 clusters since RKE2 clusters already run Helm Controller to manage internal Kubernetes components                                                                                                                                                                                                                              |
| `helmProjectOperator.helmLocker.enabled`                         | Whether to enable an embedded rancher/helm-locker instance within the Helm Project Operator.                                                                                                                                                                                                                                                                                                                                                               |
